## Phase 0: VPS Container Startup (MANDATORY)

**Context:** Containers use on-demand deployment model (resource optimization). Start only needed containers before engagement begins.

**Domain-to-Container Mapping:**
- **Network/Web/API:** `kali-pentest` (nmap, nuclei, httpx, sqlmap, etc.)
- **Web3/Smart Contracts:** `web3-security` (slither, mythril, echidna, etc.)
- **Mobile:** `mobile-security` (apktool, jadx, frida, etc.)
- **Exploitation:** `metasploit` (msfconsole, handlers)
- **Proxy Analysis:** `reaper` (HTTP intercept, database)

**Startup Command** (from local workstation):
```bash
# SSH to VPS and start needed containers
ssh -i ${OVHCLOUD_VPS_SSH_KEY} -p ${OVHCLOUD_VPS_SSH_PORT} ${OVHCLOUD_VPS_USERNAME}@${OVHCLOUD_VPS_IP} \
  "cd /root/security-tools && docker compose up -d kali-pentest"

# For multiple domains, start multiple containers:
# docker compose up -d kali-pentest web3-security metasploit
```

**Verify Containers Running:**
```bash
ssh -i ${OVHCLOUD_VPS_SSH_KEY} -p ${OVHCLOUD_VPS_SSH_PORT} ${OVHCLOUD_VPS_USERNAME}@${OVHCLOUD_VPS_IP} \
  "docker ps --format 'table {{.Names}}\t{{.Status}}'"
```

**Expected Output:**
```
NAMES              STATUS
kali-pentest      Up 3 seconds
```

**⚠️ Container Lifecycle:**
- **Start:** Beginning of engagement (this phase)
- **Stop:** End of engagement (see cleanup-and-restoration.md)
- **Why:** Prevents disk space accumulation (temp files, logs, caches)

---

## Phase 1: Engagement Intelligence Gathering

**IMPORTANT: HackerOne API credentials are stored in `../../.env`**

1. **Load API credentials** from `.env` file:
   ```powershell
   # Windows: Read credentials from .env
   $env:env:HACKERONE_USERNAME = (Select-String -Path "C:\Users\Chris\.claude\.env" -Pattern "HACKERONE_USERNAME=(.+)").Matches.Groups[1].Value
   $env:env:HACKERONE_API_TOKEN = (Select-String -Path "C:\Users\Chris\.claude\.env" -Pattern "HACKERONE_API_TOKEN=(.+)").Matches.Groups[1].Value

   # OR use Python to read .env and call API
   python -c "import os; from dotenv import load_dotenv; load_dotenv('../../.env'); print(os.getenv('HACKERONE_USERNAME'))"
   ```

2. **Extract program handle** from user input:
   - User says: "crypto.com" or "crypto" → handle: `crypto`
   - User says: "coinbase" → handle: `coinbase`
   - User says: "HackerOne" → handle: `security`
   - User says: "drumgrange" → handle: `drumgrange`

3. **Fetch program data via API** (use Python for cross-platform compatibility):
   ```python
   import os, requests, json
   from dotenv import load_dotenv

   load_dotenv('../../.env')
   username = os.getenv('HACKERONE_USERNAME')
   token = os.getenv('HACKERONE_API_TOKEN')

   # Fetch all programs
   response = requests.get(
       'https://api.hackerone.com/v1/hackers/programs',
       auth=(username, token),
       params={'page[size]': 100}
   )

   # Save to file
   with open('../../scratchpad/h1-programs.json', 'w') as f:
       json.dump(response.json(), f, indent=2)
   ```

4. **Check for loose scope files** in `output/engagements/pentest/`:
   - Look for CSV files (scope exports)
   - Look for HTML files (program policies)
   - Look for any files that don't belong to an existing engagement folder

5. **Determine readiness status**:
   - ✅ **READY**: API returns valid program data
   - ⚠️ **PARTIAL**: API works + loose files found (best case - dual intelligence)
   - ❌ **NOT READY**: API fails (401/404) + no loose files

### Phase 2: Present Findings to User

Display a status report:

```
## Penetration Testing Engagement: {Program Name}

### API Intelligence: [✅ SUCCESS / ❌ FAILED]
- Program Handle: {handle}
- Program ID: {id}
- Program Type: [Bug Bounty / VDP]
- Submission State: [open/paused/closed]
- In-Scope Assets: {count}
- Accepts Bounties: [Yes/No]
- Fast Payments: [Yes/No]
- Safe Harbor: [Yes/No]

### Top Priority Assets (Critical/High Severity):
- {asset_type}: {asset_identifier} (Max: {max_severity})
- {asset_type}: {asset_identifier} (Max: {max_severity})
[List top 5-10 assets]

### Local Files Found:
- program-policy.html (1.9 MB) - Downloaded Nov 8, 2025
- scope-data.csv (4.4 KB) - Downloaded Nov 8, 2025

### Readiness Assessment: [✅ READY / ⚠️ NEEDS FILES / ❌ NOT READY]

### Next Steps:
[Explain what happens next or what's needed]
```

### Phase 3: Invoke Pentester Agent

If **READY** or **PARTIAL**, invoke the pentester agent with complete intelligence:

```
New penetration testing engagement initialization:

Target: {program_name}
Program Handle: {handle}
Type: [Bug Bounty/VDP]
Date: {YYYY-MM}

=== API Intelligence ===
Program ID: {id}
Submission State: {open/paused/closed}
In-Scope Assets: {count}
Accepts Bounties: {true/false}
Fast Payments: {true/false}
Safe Harbor: {true/false}
Policy URL: {extended_policy_url if available}

Top Priority Assets (Critical/High):
- {asset_type}: {asset_identifier} (Max Severity: {max_severity})
- {asset_type}: {asset_identifier} (Max Severity: {max_severity})
[Top 5-10 high-value targets]

=== Local Files ===
Loose scope files found in output/engagements/pentest/:
- {filename} ({size}) - {date}

API Data Files (Temporary):
- /tmp/{handle}-program-data.json
- /tmp/{handle}-structured-scopes.json

=== Agent Instructions ===
Please execute Phase 1 of your workflow:
- Create engagement folder: output/engagements/pentest/{program}-{type}-{YYYY-MM}/
- Move loose scope files to engagement root
- Copy API JSON files to 01-scope-and-reconnaissance/api/
- Create SCOPE.md (single authorization file) using template
- Parse all scope sources (API JSON + CSV + HTML)
- Identify high-value targets from API intelligence
- DELEGATE to osint-research skill for reconnaissance (see below)
```

**OSINT Research Delegation:**

After scope parsing complete, delegate reconnaissance to osint-research skill:

```markdown
**DELEGATE to osint-research skill:**

**Caller:** security-testing
**Mode:** fast (quick recon 10-15 min) OR deep (comprehensive profiling 30-60 min)

**Research Plan:**
  - Organization profile (industry, size, locations, key personnel)
  - Technology stack (web tech, cloud providers, third-party services from job postings/tech blog)
  - Attack surface mapping (domains, subdomains, IP ranges from DNS/WHOIS)
  - Known vulnerabilities (CVE history, breach incidents, security advisories)
  - Public infrastructure (DNS records, certificate transparency, exposed services)

**Output:** output/engagements/pentest/{target}/01-scope-and-reconnaissance/osint/

**Note:** osint-research executes passive OSINT only (no active scanning/penetration testing at this stage)
```

## Decision Logic

### Scenario 1: API Success + Loose Files (BEST CASE)
→ **READY**: Full intelligence available (API + manual exports)
→ Invoke pentester agent immediately with dual intelligence

### Scenario 2: API Success + No Loose Files
→ **READY**: API provides complete scope
→ Invoke pentester agent with API-only intelligence

### Scenario 3: API Fails + Loose Files Exist
→ **PARTIAL**: Can proceed with manual exports only
→ Ask user: "API failed to fetch '{handle}'. Proceed with manual exports only?"
→ If yes: Invoke pentester agent with files-only mode

### Scenario 4: API Fails + No Files
→ **NOT READY**: Missing critical intelligence
→ Instruct user to:
  1. Verify program handle is correct (check HackerOne URL)
  2. Export scope manually (CSV + HTML)
  3. Place files in `output/engagements/pentest/`
  4. Run `/pentest-init {program}` again

## Important Notes

**DO NOT:**
- ❌ Create folders yourself
- ❌ Move files yourself
- ❌ Create authorization docs yourself
- ❌ Start reconnaissance yourself
- ❌ Parse scope yourself

**DO:**
- ✅ Source .env file for API credentials
- ✅ Fetch API data and save to /tmp/
- ✅ Read loose files in pentests directory
- ✅ Present clear status report to user
- ✅ Invoke pentester agent with ALL intelligence gathered

**The pentester agent has the complete workflow. Your job is ONLY to gather intelligence and hand off.**

## Example Usage

```powershell
# User runs command
/pentest-init crypto

# You execute:
1. Load .env credentials using Python dotenv
2. Extract handle: "crypto"
3. Invoke-RestMethod API data → Save to C:\Users\Chris\.claude\scratchpad\crypto-program-data.json
4. Check loose files → Found: program-policy.html, scope-data.csv
5. Present status → ✅ READY (API + Manual exports - BEST CASE)
6. Invoke pentester agent with complete intelligence context
```
