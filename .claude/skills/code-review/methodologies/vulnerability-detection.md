# Vulnerability Detection Methodology

**Progressive context file - Load only when conducting vulnerability analysis**

This document covers vulnerability detection methodologies for security code reviews.

---

## Overview

Vulnerability detection is the systematic identification of security weaknesses in source code that could be exploited by attackers. All code reviews must follow OWASP Code Review Guide and CWE classifications.

**Primary Methodologies:**
1. **OWASP Top 10** - Most critical web application security risks
2. **CWE Top 25** - Most dangerous software weaknesses
3. **Static Analysis** - Automated pattern matching for known vulnerabilities
4. **Manual Review** - Deep code inspection for logic flaws and business logic vulnerabilities

---

## OWASP Top 10 (2021)

### A01:2021 - Broken Access Control

**Description:** Failures in access control allow users to act outside their permissions

**Code Patterns to Review:**

**Insecure Direct Object Reference (IDOR):**
```python
# VULNERABLE - No authorization check
@app.route('/user/<user_id>')
def get_user(user_id):
    user = User.query.get(user_id)  # Any user can access any user_id
    return jsonify(user.to_dict())

# SECURE - Authorization check
@app.route('/user/<user_id>')
@login_required
def get_user(user_id):
    if current_user.id != user_id and not current_user.is_admin:
        abort(403)  # Forbidden
    user = User.query.get(user_id)
    return jsonify(user.to_dict())
```

**Missing Function Level Access Control:**
```javascript
// VULNERABLE - No admin check
app.delete('/api/users/:id', (req, res) => {
    deleteUser(req.params.id);  // Any authenticated user can delete
});

// SECURE - Admin check
app.delete('/api/users/:id', requireAdmin, (req, res) => {
    deleteUser(req.params.id);
});
```

**CWE References:** CWE-639 (Authorization Bypass), CWE-862 (Missing Authorization)

---

### A02:2021 - Cryptographic Failures

**Description:** Failures related to cryptography leading to sensitive data exposure

**Code Patterns to Review:**

**Hardcoded Credentials:**
```java
// VULNERABLE - Hardcoded password
String password = "admin123";
Connection conn = DriverManager.getConnection(url, "admin", password);

// SECURE - Environment variable
String password = System.getenv("DB_PASSWORD");
Connection conn = DriverManager.getConnection(url, "admin", password);
```

**Weak Hashing:**
```python
# VULNERABLE - MD5 is cryptographically broken
import hashlib
password_hash = hashlib.md5(password.encode()).hexdigest()

# SECURE - bcrypt with salt
import bcrypt
password_hash = bcrypt.hashpw(password.encode(), bcrypt.gensalt())
```

**Insecure Random:**
```java
// VULNERABLE - Predictable random
Random random = new Random();
String token = String.valueOf(random.nextInt());

// SECURE - Cryptographically secure random
SecureRandom secureRandom = new SecureRandom();
byte[] token = new byte[32];
secureRandom.nextBytes(token);
```

**CWE References:** CWE-798 (Hardcoded Credentials), CWE-327 (Broken Crypto), CWE-330 (Weak Random)

---

### A03:2021 - Injection

**Description:** User-supplied data not validated, filtered, or sanitized

**SQL Injection:**
```python
# VULNERABLE - String concatenation
query = f"SELECT * FROM users WHERE username = '{username}'"
cursor.execute(query)

# SECURE - Parameterized query
query = "SELECT * FROM users WHERE username = ?"
cursor.execute(query, (username,))
```

**Command Injection:**
```javascript
// VULNERABLE - User input in shell command
const { exec } = require('child_process');
exec(`ping ${userInput}`, (error, stdout) => { ... });

// SECURE - Input validation + whitelist
const allowedHosts = ['localhost', '8.8.8.8'];
if (!allowedHosts.includes(userInput)) {
    throw new Error('Invalid host');
}
exec(`ping ${userInput}`, (error, stdout) => { ... });
```

**LDAP Injection:**
```java
// VULNERABLE - Unfiltered LDAP query
String filter = "(uid=" + username + ")";
NamingEnumeration results = ctx.search("ou=users", filter, controls);

// SECURE - Escaped input
String filter = "(uid=" + LdapEncoder.filterEncode(username) + ")";
NamingEnumeration results = ctx.search("ou=users", filter, controls);
```

**CWE References:** CWE-89 (SQL Injection), CWE-78 (OS Command Injection), CWE-90 (LDAP Injection)

---

### A04:2021 - Insecure Design

**Description:** Missing or ineffective security controls in design

**Code Patterns to Review:**

**Lack of Rate Limiting:**
```python
# VULNERABLE - No rate limiting
@app.route('/login', methods=['POST'])
def login():
    username = request.form['username']
    password = request.form['password']
    # Allows unlimited brute force attempts
    if authenticate(username, password):
        return "Success"
```

**Missing Security Headers:**
```javascript
// VULNERABLE - No security headers
app.get('/', (req, res) => {
    res.send('<html>...</html>');
});

// SECURE - Security headers
app.use(helmet());  // Adds X-Frame-Options, CSP, etc.
```

**CWE References:** CWE-307 (No Brute Force Protection), CWE-1021 (Improper Input Validation)

---

### A05:2021 - Security Misconfiguration

**Description:** Insecure default configurations, incomplete setups

**Code Patterns to Review:**

**Debug Mode in Production:**
```python
# VULNERABLE - Debug mode enabled
app = Flask(__name__)
app.debug = True  # Exposes stack traces, source code

# SECURE - Debug disabled in production
app.debug = os.getenv('FLASK_ENV') == 'development'
```

**Verbose Error Messages:**
```java
// VULNERABLE - Detailed error messages
try {
    // database operation
} catch (SQLException e) {
    return "Database error: " + e.getMessage();  // Leaks DB structure
}

// SECURE - Generic error message
try {
    // database operation
} catch (SQLException e) {
    logger.error("Database error", e);
    return "An error occurred. Please try again.";
}
```

**CWE References:** CWE-209 (Information Exposure), CWE-756 (Missing Error Handling)

---

### A06:2021 - Vulnerable and Outdated Components

**Description:** Using components with known vulnerabilities

**Code Patterns to Review:**

**Outdated Dependencies:**
```json
// VULNERABLE - Old version with known CVEs
"dependencies": {
  "lodash": "4.17.4",  // CVE-2019-10744
  "express": "4.16.0"  // Multiple CVEs
}

// SECURE - Updated versions
"dependencies": {
  "lodash": "4.17.21",
  "express": "4.18.2"
}
```

**Note:** This is primarily detected by dependency-audit skill, but code review should verify no workarounds bypass security fixes.

**CWE References:** CWE-1035 (Using Component with Known Vulnerability)

---

### A07:2021 - Identification and Authentication Failures

**Description:** Failures in authentication implementation

**Code Patterns to Review:**

**Weak Password Requirements:**
```python
# VULNERABLE - Weak password policy
def register(username, password):
    if len(password) < 6:
        return "Password too short"
    # No complexity requirements

# SECURE - Strong password policy
def register(username, password):
    if len(password) < 12:
        return "Password must be at least 12 characters"
    if not re.search(r'[A-Z]', password):
        return "Password must contain uppercase"
    if not re.search(r'[a-z]', password):
        return "Password must contain lowercase"
    if not re.search(r'[0-9]', password):
        return "Password must contain digit"
```

**Session Fixation:**
```php
// VULNERABLE - Session ID not regenerated
session_start();
$_SESSION['username'] = $username;

// SECURE - Regenerate session ID after login
session_start();
session_regenerate_id(true);
$_SESSION['username'] = $username;
```

**CWE References:** CWE-521 (Weak Password), CWE-384 (Session Fixation)

---

### A08:2021 - Software and Data Integrity Failures

**Description:** Code/infrastructure that doesn't protect against integrity violations

**Code Patterns to Review:**

**Insecure Deserialization:**
```python
# VULNERABLE - Unsafe pickle deserialization
import pickle
data = pickle.loads(user_input)  # Can execute arbitrary code

# SECURE - Use JSON for untrusted data
import json
data = json.loads(user_input)  # Only deserializes data structures
```

**Missing Integrity Checks:**
```javascript
// VULNERABLE - No integrity verification
const script = document.createElement('script');
script.src = 'https://cdn.example.com/lib.js';
document.body.appendChild(script);

// SECURE - Subresource Integrity
const script = document.createElement('script');
script.src = 'https://cdn.example.com/lib.js';
script.integrity = 'sha384-oqVuAfXRKap7fdgcCY5uykM6+R9GqQ8K/u...';
script.crossOrigin = 'anonymous';
document.body.appendChild(script);
```

**CWE References:** CWE-502 (Deserialization of Untrusted Data), CWE-494 (Download of Code Without Integrity Check)

---

### A09:2021 - Security Logging and Monitoring Failures

**Description:** Insufficient logging and monitoring

**Code Patterns to Review:**

**Missing Security Event Logging:**
```java
// VULNERABLE - No logging of authentication events
public boolean login(String username, String password) {
    if (authenticate(username, password)) {
        return true;
    }
    return false;  // Failed login not logged
}

// SECURE - Log authentication events
public boolean login(String username, String password) {
    if (authenticate(username, password)) {
        logger.info("Successful login: {}", username);
        return true;
    }
    logger.warn("Failed login attempt: {}", username);
    return false;
}
```

**Logging Sensitive Data:**
```python
# VULNERABLE - Logs password
logger.info(f"Login attempt: {username} / {password}")

# SECURE - Don't log sensitive data
logger.info(f"Login attempt: {username}")
```

**CWE References:** CWE-778 (Insufficient Logging), CWE-532 (Information Exposure Through Log Files)

---

### A10:2021 - Server-Side Request Forgery (SSRF)

**Description:** Application fetches remote resources without validating user-supplied URL

**Code Patterns to Review:**

**Unvalidated URL Fetch:**
```python
# VULNERABLE - Fetches arbitrary URL
import requests
url = request.args.get('url')
response = requests.get(url)  # Can access internal services

# SECURE - Whitelist allowed domains
ALLOWED_DOMAINS = ['api.example.com', 'cdn.example.com']
parsed = urlparse(url)
if parsed.netloc not in ALLOWED_DOMAINS:
    abort(400, "Invalid URL")
response = requests.get(url)
```

**CWE References:** CWE-918 (SSRF)

---

## CWE Top 25 (2023)

**Beyond OWASP Top 10, also review for:**

1. **CWE-787** - Out-of-bounds Write (buffer overflow)
2. **CWE-79** - Cross-Site Scripting (XSS)
3. **CWE-20** - Improper Input Validation
4. **CWE-125** - Out-of-bounds Read
5. **CWE-22** - Path Traversal
6. **CWE-352** - CSRF
7. **CWE-434** - Unrestricted Upload of Dangerous File Type
8. **CWE-862** - Missing Authorization
9. **CWE-476** - NULL Pointer Dereference
10. **CWE-287** - Improper Authentication

**See:** `reference/cwe-top-25.md` for complete list with examples

---

## Vulnerability Severity Scoring

### CVSS v3.1 Calculation

**Base Score Components:**

**Attack Vector (AV):**
- Network (N): 0.85
- Adjacent (A): 0.62
- Local (L): 0.55
- Physical (P): 0.20

**Attack Complexity (AC):**
- Low (L): 0.77
- High (H): 0.44

**Privileges Required (PR):**
- None (N): 0.85
- Low (L): 0.62 (0.68 if scope changed)
- High (H): 0.27 (0.50 if scope changed)

**User Interaction (UI):**
- None (N): 0.85
- Required (R): 0.62

**Scope (S):**
- Unchanged (U)
- Changed (C)

**Impact (Confidentiality, Integrity, Availability):**
- None (N): 0
- Low (L): 0.22
- High (H): 0.56

**Severity Ratings:**
- **Critical:** 9.0-10.0
- **High:** 7.0-8.9
- **Medium:** 4.0-6.9
- **Low:** 0.1-3.9

**CVSS Calculator:** https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator

---

## Review Checklist by Language

### Python

- [ ] SQL injection (use parameterized queries, not string formatting)
- [ ] Command injection (avoid `os.system`, `subprocess.call` with shell=True)
- [ ] Path traversal (validate file paths, use `os.path.abspath`)
- [ ] Pickle deserialization (never `pickle.loads` untrusted data)
- [ ] Weak crypto (use `secrets` not `random`, bcrypt/argon2 for passwords)
- [ ] Debug mode in production (`app.debug = False`)

### JavaScript/Node.js

- [ ] XSS (sanitize output, use CSP headers)
- [ ] Prototype pollution (validate object keys)
- [ ] Command injection (`child_process.exec` with user input)
- [ ] Path traversal (validate file paths)
- [ ] SQL injection (use parameterized queries)
- [ ] Missing rate limiting (especially on authentication)
- [ ] Missing security headers (use `helmet` middleware)

### Java

- [ ] SQL injection (use `PreparedStatement`, not string concatenation)
- [ ] XXE (disable external entities in XML parsers)
- [ ] Deserialization (never deserialize untrusted data)
- [ ] Path traversal (validate file paths)
- [ ] LDAP injection (escape user input)
- [ ] Weak random (`SecureRandom` not `Random`)
- [ ] Hardcoded credentials (use environment variables, KeyStore)

### C/C++

- [ ] Buffer overflow (use bounds checking, `strncpy` not `strcpy`)
- [ ] Format string vulnerabilities (never `printf(user_input)`)
- [ ] Integer overflow (check arithmetic operations)
- [ ] Use after free (memory management errors)
- [ ] NULL pointer dereference
- [ ] Race conditions (proper synchronization)

**See:** `reference/language-specific.md` for complete language-specific checklists

---

## Proof-of-Concept Requirements

**All security findings MUST include POC or code example**

**Good POC Example:**
```
Finding: SQL Injection in user search
File: app/controllers/users_controller.py:42
CWE: CWE-89

Vulnerable Code:
    query = f"SELECT * FROM users WHERE username = '{username}'"
    cursor.execute(query)

Proof-of-Concept:
    username = "admin' OR '1'='1"
    Results in query: SELECT * FROM users WHERE username = 'admin' OR '1'='1'
    This bypasses authentication and returns all users.

Remediation:
    query = "SELECT * FROM users WHERE username = ?"
    cursor.execute(query, (username,))
```

**Bad POC Example (Missing Evidence):**
```
Finding: SQL Injection vulnerability
File: users_controller.py
CWE: CWE-89

The application may be vulnerable to SQL injection.
```

---

## Common Mistakes to Avoid

**❌ Generic vulnerability names**
- Bad: "Security issue in login function"
- Good: "CWE-89 SQL Injection in authentication query (users_controller.py:42)"

**❌ No POC/evidence**
- Must include vulnerable code snippet + exploit example

**❌ Missing CWE classification**
- All findings must map to CWE IDs

**❌ Missing severity rating**
- Calculate CVSS score or use Critical/High/Medium/Low

**❌ No remediation guidance**
- Provide specific code fix, not just "fix this vulnerability"

---

**Version:** 2.0
**Last Updated:** 2025-12-02
**Framework:** OWASP Top 10 (2021), CWE Top 25 (2023), CVSS v3.1
