#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
nuclei wrapper - MCP Code API Pattern (VPS Docker deployment)
Executes nuclei, saves raw output, returns parsed summary
"""

import sys
import io
import json
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def nuclei(target: str, templates: str = "", severity: str = "", engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute nuclei template-based vulnerability scanning.

    Args:
        target: Target URL/domain/file with list of targets
        templates: Template specification (e.g., 'cves', 'exposures')
        severity: Severity filter (critical, high, medium, low, info)
        engagement_dir: Optional engagement directory path

    Returns:
        Dict with:
        - summary: Parsed findings (count by severity, template categories)
        - outputFile: Path to raw nuclei output (JSON format)
        - message: Human-readable summary
    """

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    safe_target = target.replace("/", "_").replace(":", "_").replace(".", "_")
    filename = f"{safe_target}-{timestamp}.json"

    # Determine output directory
    if engagement_dir:
        output_dir = Path(engagement_dir) / "03-vulnerability-assessment" / "nuclei"
    else:
        session_date = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / session_date / "scans" / "nuclei"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / filename

    # Build command (nuclei uses -jsonl for JSON Lines output)
    cmd = f"nuclei -u {target} -jsonl"
    if templates:
        cmd += f" -t {templates}"
    if severity:
        cmd += f" -severity {severity}"

    try:
        result = docker_exec("kali-pentest", cmd, timeout=600)

        if result["returncode"] != 0:
            # Write error to file for audit trail
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(f"[!] Nuclei execution failed\n")
                f.write(f"Command: {cmd}\n")
                f.write(f"Exit code: {result['returncode']}\n\n")
                f.write(f"STDERR:\n{result['stderr']}\n\n")
                f.write(f"STDOUT:\n{result['stdout']}\n")

            return {
                "error": f"Nuclei execution failed: {result['stderr']}",
                "outputFile": str(output_file)
            }

        # Write output to local file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(result["stdout"])

        # Parse the output
        summary = parse_nuclei_output(output_file)

        # Generate message
        total = summary["totalFindings"]
        message = f"[+] nuclei scan complete\n"
        message += f"    Target: {target}\n"
        message += f"    Findings: {total}\n"

        if summary["bySeverity"]:
            message += f"    By severity:\n"
            for sev in ['critical', 'high', 'medium', 'low', 'info']:
                if sev in summary["bySeverity"]:
                    message += f"      {sev.upper()}: {summary['bySeverity'][sev]}\n"

        if summary["topFindings"]:
            message += f"    Top findings (first 5):\n"
            for finding in summary["topFindings"][:5]:
                message += f"      [{finding['severity'].upper()}] {finding['name']}\n"

        message += f"    Full results: {output_file}"

        return {
            "summary": summary,
            "outputFile": str(output_file),
            "message": message
        }

    except Exception as e:
        # Write error to file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(f"[!] Nuclei wrapper error\n")
            f.write(f"Error: {str(e)}\n")

        return {
            "error": f"Nuclei execution error: {str(e)}",
            "outputFile": str(output_file)
        }


def parse_nuclei_output(filepath: Path) -> Dict:
    """Parse nuclei JSON output file."""

    if not filepath.exists():
        return {
            "totalFindings": 0,
            "bySeverity": {},
            "byCategory": {},
            "topFindings": []
        }

    findings = []
    by_severity = {}
    by_category = {}

    with open(filepath, 'r', encoding='utf-8') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue

            try:
                finding = json.loads(line)
                findings.append(finding)

                # Count by severity
                severity = finding.get('info', {}).get('severity', 'unknown')
                by_severity[severity] = by_severity.get(severity, 0) + 1

                # Count by category/tags
                tags = finding.get('info', {}).get('tags', [])
                if isinstance(tags, list):
                    for tag in tags:
                        by_category[tag] = by_category.get(tag, 0) + 1

            except json.JSONDecodeError:
                continue

    # Extract top findings for summary
    top_findings = []
    for finding in findings[:20]:  # Top 20
        top_findings.append({
            "name": finding.get('info', {}).get('name', 'Unknown'),
            "severity": finding.get('info', {}).get('severity', 'unknown'),
            "matched": finding.get('matched-at', ''),
            "template": finding.get('template-id', '')
        })

    return {
        "totalFindings": len(findings),
        "bySeverity": by_severity,
        "byCategory": by_category,
        "topFindings": top_findings
    }


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python nuclei.py <target> [templates] [severity] [engagement_dir]")
        print("Example: python nuclei.py https://example.com")
        print("Example: python nuclei.py https://example.com 'cves' 'critical,high'")
        sys.exit(1)

    target = sys.argv[1]
    templates = sys.argv[2] if len(sys.argv) > 2 else ""
    severity = sys.argv[3] if len(sys.argv) > 3 else ""
    engagement_dir = sys.argv[4] if len(sys.argv) > 4 else None

    result = nuclei(target, templates, severity, engagement_dir)

    if "error" in result:
        print(f"[!] Error: {result['error']}")
        sys.exit(1)
    else:
        print(result["message"])
