#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
naabu wrapper - MCP Code API Pattern (VPS Docker deployment)
Executes naabu, saves raw output, returns parsed summary
"""

import sys
import io
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def naabu(target: str, ports: str = "", options: str = "", engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute naabu fast port scanning.

    Args:
        target: Target IP/hostname/CIDR
        ports: Port specification (e.g., "80,443" or "1-1000")
        options: Additional naabu options
        engagement_dir: Optional engagement directory path

    Returns:
        Dict with:
        - summary: Parsed findings (open ports by host)
        - outputFile: Path to raw naabu output
        - message: Human-readable summary
    """

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    safe_target = target.replace("/", "_").replace(":", "_")
    filename = f"{safe_target}-{timestamp}.txt"

    # Determine output directory
    if engagement_dir:
        output_dir = Path(engagement_dir) / "02-reconnaissance" / "naabu"
    else:
        session_date = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / session_date / "scans" / "naabu"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / filename

    # Build command
    cmd = f"naabu -host {target}"
    if ports:
        cmd += f" -p {ports}"
    if options:
        cmd += f" {options}"
    cmd += f" -o {output_file}"

    try:
        result = docker_exec("kali-pentest", cmd, timeout=300)

        if result["returncode"] != 0 and not output_file.exists():
            return {
                "error": f"naabu execution failed: {result["stderr"]}",
                "outputFile": str(output_file)
            }

        # Parse the output
        summary = parse_naabu_output(output_file)

        # Generate message
        total_ports = summary["totalPorts"]
        message = f"[+] naabu scan complete\n"
        message += f"    Target: {target}\n"
        message += f"    Open ports found: {total_ports}\n"

        if summary["portsByHost"]:
            message += f"    Breakdown:\n"
            for host, ports_list in list(summary["portsByHost"].items())[:5]:
                message += f"      {host}: {len(ports_list)} ports - {', '.join(map(str, sorted(ports_list)[:10]))}\n"
                if len(ports_list) > 10:
                    message += f"        ... and {len(ports_list) - 10} more\n"

        message += f"    Full results: {output_file}"

        return {
            "summary": summary,
            "outputFile": str(output_file),
            "message": message
        }

    except subprocess.TimeoutExpired:
        return {
            "error": "naabu timed out (5 minutes)",
            "outputFile": str(output_file)
        }
    except Exception as e:
        return {
            "error": f"naabu execution error: {str(e)}",
            "outputFile": str(output_file)
        }


def parse_naabu_output(filepath: Path) -> Dict:
    """Parse naabu output file."""

    if not filepath.exists():
        return {
            "totalPorts": 0,
            "portsByHost": {}
        }

    ports_by_host = {}

    with open(filepath, 'r', encoding='utf-8') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue

            # Parse naabu output format: host:port
            if ':' in line:
                parts = line.rsplit(':', 1)
                if len(parts) == 2:
                    host = parts[0]
                    try:
                        port = int(parts[1])
                        if host not in ports_by_host:
                            ports_by_host[host] = []
                        ports_by_host[host].append(port)
                    except ValueError:
                        continue

    total_ports = sum(len(ports) for ports in ports_by_host.values())

    return {
        "totalPorts": total_ports,
        "portsByHost": ports_by_host
    }


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python naabu.py <target> [ports] [options] [engagement_dir]")
        print("Example: python naabu.py 192.168.1.1")
        print("Example: python naabu.py 192.168.1.0/24 '80,443,8080'")
        sys.exit(1)

    target = sys.argv[1]
    ports = sys.argv[2] if len(sys.argv) > 2 else ""
    options = sys.argv[3] if len(sys.argv) > 3 else ""
    engagement_dir = sys.argv[4] if len(sys.argv) > 4 else None

    result = naabu(target, ports, options, engagement_dir)

    if "error" in result:
        print(f"[!] Error: {result['error']}")
        sys.exit(1)
    else:
        print(result["message"])
