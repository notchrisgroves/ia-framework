#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
wpscan wrapper - MCP Code API Pattern (VPS Docker deployment)
Executes wpscan, saves raw output, returns parsed summary
"""

import sys
import io
import json
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def wpscan(url: str, options: str = "", engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute wpscan WordPress vulnerability scanning.

    Args:
        url: Target WordPress URL
        options: Additional wpscan options
        engagement_dir: Optional engagement directory path

    Returns:
        Dict with:
        - summary: Parsed findings (WordPress version, plugins, themes, vulnerabilities)
        - outputFile: Path to raw wpscan output (JSON format)
        - message: Human-readable summary
    """

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    from urllib.parse import urlparse
    parsed = urlparse(url)
    safe_domain = parsed.netloc.replace(":", "_") if parsed.netloc else url.replace("/", "_").replace(":", "_")
    filename = f"{safe_domain}-{timestamp}.json"

    # Determine output directory
    if engagement_dir:
        output_dir = Path(engagement_dir) / "03-vulnerability-assessment" / "wpscan"
    else:
        session_date = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / session_date / "scans" / "wpscan"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / filename

    # Execute wpscan with JSON output
    cmd = f"wpscan --url {url} {options} --format json -o {output_file}"

    try:
        result = subprocess.run(
            cmd,
            shell=True,
            capture_output=True,
            text=True,
            timeout=900  # 15 minute timeout
        )

        # wpscan may return non-zero even with results
        if not output_file.exists():
            return {
                "error": f"wpscan execution failed: {result["stderr"]}",
                "outputFile": str(output_file)
            }

        # Parse the output
        summary = parse_wpscan_output(output_file)

        # Generate message
        message = f"[+] wpscan complete\n"
        message += f"    Target: {url}\n"

        if summary["wordpressVersion"]:
            message += f"    WordPress: {summary['wordpressVersion']}\n"

        if summary["vulnerabilities"]:
            message += f"    Vulnerabilities: {summary['vulnerabilities']}\n"

        if summary["plugins"]:
            message += f"    Plugins detected: {len(summary['plugins'])}\n"
            if summary["vulnerablePlugins"]:
                message += f"      Vulnerable: {summary['vulnerablePlugins']}\n"

        if summary["themes"]:
            message += f"    Themes detected: {len(summary['themes'])}\n"

        if summary["interestingFindings"]:
            message += f"    Interesting findings ({len(summary['interestingFindings'])}):\n"
            for finding in summary["interestingFindings"][:5]:
                message += f"      - {finding}\n"

        message += f"    Full results: {output_file}"

        return {
            "summary": summary,
            "outputFile": str(output_file),
            "message": message
        }

    except subprocess.TimeoutExpired:
        return {
            "error": "wpscan timed out (15 minutes)",
            "outputFile": str(output_file)
        }
    except Exception as e:
        return {
            "error": f"wpscan execution error: {str(e)}",
            "outputFile": str(output_file)
        }


def parse_wpscan_output(filepath: Path) -> Dict:
    """Parse wpscan JSON output file."""

    if not filepath.exists():
        return {
            "wordpressVersion": "",
            "vulnerabilities": 0,
            "plugins": [],
            "vulnerablePlugins": 0,
            "themes": [],
            "interestingFindings": []
        }

    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            data = json.load(f)
    except json.JSONDecodeError:
        return {
            "wordpressVersion": "",
            "vulnerabilities": 0,
            "plugins": [],
            "vulnerablePlugins": 0,
            "themes": [],
            "interestingFindings": []
        }

    # Extract WordPress version
    wp_version = ""
    version_data = data.get('version', {})
    if version_data:
        wp_version = version_data.get('number', '')

    # Count total vulnerabilities
    total_vulns = 0
    if version_data and 'vulnerabilities' in version_data:
        total_vulns += len(version_data['vulnerabilities'])

    # Extract plugins
    plugins = []
    vulnerable_plugins = 0
    plugins_data = data.get('plugins', {})
    for plugin_name, plugin_info in plugins_data.items():
        plugins.append(plugin_name)
        if 'vulnerabilities' in plugin_info and plugin_info['vulnerabilities']:
            vulnerable_plugins += 1
            total_vulns += len(plugin_info['vulnerabilities'])

    # Extract themes
    themes = []
    themes_data = data.get('themes', {})
    for theme_name, theme_info in themes_data.items():
        themes.append(theme_name)
        if 'vulnerabilities' in theme_info and theme_info['vulnerabilities']:
            total_vulns += len(theme_info['vulnerabilities'])

    # Extract interesting findings
    interesting = []
    interesting_data = data.get('interesting_findings', [])
    for finding in interesting_data:
        if 'to_s' in finding:
            interesting.append(finding['to_s'])
        elif 'url' in finding:
            interesting.append(finding['url'])

    return {
        "wordpressVersion": wp_version,
        "vulnerabilities": total_vulns,
        "plugins": plugins,
        "vulnerablePlugins": vulnerable_plugins,
        "themes": themes,
        "interestingFindings": interesting
    }


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python wpscan.py <url> [options] [engagement_dir]")
        print("Example: python wpscan.py https://example.com")
        print("Example: python wpscan.py https://example.com '--enumerate p,t,u'")
        sys.exit(1)

    url = sys.argv[1]
    options = sys.argv[2] if len(sys.argv) > 2 else ""
    engagement_dir = sys.argv[3] if len(sys.argv) > 3 else None

    result = wpscan(url, options, engagement_dir)

    if "error" in result:
        print(f"[!] Error: {result['error']}")
        sys.exit(1)
    else:
        print(result["message"])
