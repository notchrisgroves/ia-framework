#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
katana wrapper - MCP Code API Pattern (VPS Docker deployment)
Executes katana, saves raw output, returns parsed summary
"""

import sys
import io
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec
from urllib.parse import urlparse

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def katana(url: str, depth: str = "2", options: str = "", engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute katana web crawling for endpoint discovery.

    Args:
        url: Target URL to crawl
        depth: Crawl depth (default: 2)
        options: Additional katana options
        engagement_dir: Optional engagement directory path

    Returns:
        Dict with:
        - summary: Parsed findings (total endpoints, categories)
        - outputFile: Path to raw katana output
        - message: Human-readable summary
    """

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    parsed = urlparse(url)
    safe_domain = parsed.netloc.replace(":", "_") if parsed.netloc else url.replace("/", "_").replace(":", "_")
    filename = f"{safe_domain}-{timestamp}.txt"

    # Determine output directory
    if engagement_dir:
        output_dir = Path(engagement_dir) / "02-reconnaissance" / "katana"
    else:
        session_date = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / session_date / "scans" / "katana"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / filename

    # Execute katana
    cmd = f"katana -u {url} -d {depth} {options} -o {output_file}"

    try:
        result = subprocess.run(
            cmd,
            shell=True,
            capture_output=True,
            text=True,
            timeout=600  # 10 minute timeout for crawling
        )

        if result["returncode"] != 0 and not output_file.exists():
            return {
                "error": f"katana execution failed: {result["stderr"]}",
                "outputFile": str(output_file)
            }

        # Parse the output
        summary = parse_katana_output(output_file)

        # Generate message
        total = summary["totalEndpoints"]
        message = f"[+] katana crawl complete\n"
        message += f"    Target: {url}\n"
        message += f"    Depth: {depth}\n"
        message += f"    Endpoints found: {total}\n"

        if summary["categories"]:
            message += f"    Breakdown:\n"
            for category, count in sorted(summary["categories"].items(), key=lambda x: x[1], reverse=True):
                message += f"      {category}: {count}\n"

        if summary["sampleEndpoints"]:
            message += f"    Sample endpoints (first 10):\n"
            for endpoint in summary["sampleEndpoints"][:10]:
                message += f"      - {endpoint}\n"

        message += f"    Full results: {output_file}"

        return {
            "summary": summary,
            "outputFile": str(output_file),
            "message": message
        }

    except subprocess.TimeoutExpired:
        return {
            "error": "katana timed out (10 minutes)",
            "outputFile": str(output_file)
        }
    except Exception as e:
        return {
            "error": f"katana execution error: {str(e)}",
            "outputFile": str(output_file)
        }


def parse_katana_output(filepath: Path) -> Dict:
    """Parse katana output file."""

    if not filepath.exists():
        return {
            "totalEndpoints": 0,
            "categories": {},
            "sampleEndpoints": []
        }

    endpoints = []
    categories = {}

    with open(filepath, 'r', encoding='utf-8') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue

            endpoints.append(line)

            # Categorize endpoints
            parsed = urlparse(line)
            path = parsed.path.lower()

            if any(ext in path for ext in ['.js', '.jsx', '.ts', '.tsx']):
                categories['JavaScript'] = categories.get('JavaScript', 0) + 1
            elif any(ext in path for ext in ['.css', '.scss', '.sass']):
                categories['Stylesheets'] = categories.get('Stylesheets', 0) + 1
            elif any(ext in path for ext in ['.jpg', '.jpeg', '.png', '.gif', '.svg', '.webp']):
                categories['Images'] = categories.get('Images', 0) + 1
            elif any(ext in path for ext in ['.json', '.xml']):
                categories['Data Files'] = categories.get('Data Files', 0) + 1
            elif '/api/' in path or '/v1/' in path or '/v2/' in path:
                categories['API Endpoints'] = categories.get('API Endpoints', 0) + 1
            elif parsed.query:
                categories['Parameterized'] = categories.get('Parameterized', 0) + 1
            else:
                categories['Pages'] = categories.get('Pages', 0) + 1

    return {
        "totalEndpoints": len(endpoints),
        "categories": categories,
        "sampleEndpoints": endpoints[:20]  # First 20 for sample
    }


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python katana.py <url> [depth] [options] [engagement_dir]")
        print("Example: python katana.py https://example.com")
        print("Example: python katana.py https://example.com 3 '-jc'")
        sys.exit(1)

    url = sys.argv[1]
    depth = sys.argv[2] if len(sys.argv) > 2 else "2"
    options = sys.argv[3] if len(sys.argv) > 3 else ""
    engagement_dir = sys.argv[4] if len(sys.argv) > 4 else None

    result = katana(url, depth, options, engagement_dir)

    if "error" in result:
        print(f"[!] Error: {result['error']}")
        sys.exit(1)
    else:
        print(result["message"])
