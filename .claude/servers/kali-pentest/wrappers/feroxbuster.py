#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
feroxbuster wrapper - MCP Code API Pattern (VPS Docker deployment)
Fast, recursive content discovery tool written in Rust
"""

import sys
import io
import re
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def feroxbuster(target: str, wordlist: str = "/usr/share/wordlists/dirb/common.txt",
                options: str = "", engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute feroxbuster content discovery on VPS and return parsed summary.

    Args:
        target: Target URL (e.g., https://example.com)
        wordlist: Path to wordlist on VPS container (default: dirb common.txt)
        options: Additional feroxbuster options (e.g., "-t 50 -d 2 --no-recursion")
        engagement_dir: Optional engagement directory path
                       If provided, saves to engagement/02-reconnaissance/feroxbuster/
                       If None, saves to sessions/[date]/scans/feroxbuster/

    Returns:
        Dict with:
        - summary: Parsed findings (discovered paths, status codes)
        - outputFile: Path to raw feroxbuster output (local)
        - message: Human-readable summary
    """

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    # Extract domain from URL for filename
    domain = re.sub(r'https?://', '', target).split('/')[0].replace(':', '_')
    filename = f"{domain}-{timestamp}.txt"

    # Determine output directory (local storage)
    if engagement_dir:
        output_dir = Path(engagement_dir) / "02-reconnaissance" / "feroxbuster"
    else:
        session_date = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / session_date / "scans" / "feroxbuster"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / filename

    # Build feroxbuster command
    # --no-state prevents state file creation, --quiet reduces noise
    cmd = f"feroxbuster -u {target} -w {wordlist} --no-state -q {options}"

    try:
        result = docker_exec("kali-pentest", cmd, timeout=900)  # 15 min timeout for recursion

        if result["returncode"] != 0:
            # Write error to file for audit trail
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(f"[!] feroxbuster execution failed\n")
                f.write(f"Command: {cmd}\n")
                f.write(f"Exit code: {result['returncode']}\n\n")
                f.write(f"STDERR:\n{result['stderr']}\n\n")
                f.write(f"STDOUT:\n{result['stdout']}\n")

            return {
                "error": f"feroxbuster execution failed: {result['stderr']}",
                "outputFile": str(output_file)
            }

        # Write output to local file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(result["stdout"])

        # Parse the output
        summary = parse_feroxbuster_output(result["stdout"])

        # Generate human-readable message
        found_count = len(summary["discovered"])

        message = f"[+] feroxbuster scan complete (VPS: kali-pentest container)\n"
        message += f"    Target: {target}\n"
        message += f"    Wordlist: {wordlist}\n"
        message += f"    Discovered: {found_count} paths\n"

        if summary["discovered"][:5]:  # Show first 5
            message += f"    Top results:\n"
            for item in summary["discovered"][:5]:
                message += f"      [{item['status']}] {item['url']} ({item['size']} bytes)\n"

        if found_count > 5:
            message += f"      ... and {found_count - 5} more\n"

        message += f"    Full results: {output_file}"

        return {
            "summary": summary,
            "outputFile": str(output_file),
            "message": message
        }

    except Exception as e:
        # Write error to file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(f"[!] feroxbuster wrapper error\n")
            f.write(f"Error: {str(e)}\n")

        return {
            "error": f"feroxbuster execution error: {str(e)}",
            "outputFile": str(output_file)
        }


def parse_feroxbuster_output(content: str) -> Dict:
    """
    Parse feroxbuster output and extract discovered paths.

    Feroxbuster output format:
    200      GET       12l       34w      567c https://example.com/path

    Returns:
        Dict with discovered paths, status codes, sizes
    """

    discovered = []

    # Pattern: STATUS METHOD LINES WORDS CHARS URL
    pattern = r'^(\d{3})\s+\w+\s+\d+l\s+\d+w\s+(\d+)c\s+(https?://\S+)'

    for line in content.split('\n'):
        match = re.match(pattern, line.strip())
        if match:
            discovered.append({
                "status": int(match.group(1)),
                "size": int(match.group(2)),
                "url": match.group(3)
            })

    # Sort by status code, then by URL
    discovered.sort(key=lambda x: (x['status'], x['url']))

    return {
        "discovered": discovered,
        "total": len(discovered),
        "statusCodes": list(set(d['status'] for d in discovered))
    }


if __name__ == "__main__":
    # CLI usage for testing
    if len(sys.argv) < 2:
        print("Usage: python feroxbuster.py <target_url> [wordlist] [options] [engagement_dir]")
        print("Example: python feroxbuster.py https://example.com")
        print("Example: python feroxbuster.py https://example.com /usr/share/wordlists/dirb/big.txt '-t 50 -d 2'")
        sys.exit(1)

    target = sys.argv[1]
    wordlist = sys.argv[2] if len(sys.argv) > 2 else "/usr/share/wordlists/dirb/common.txt"
    options = sys.argv[3] if len(sys.argv) > 3 else ""
    engagement_dir = sys.argv[4] if len(sys.argv) > 4 else None

    result = feroxbuster(target, wordlist, options, engagement_dir)

    if "error" in result:
        print(f"[!] Error: {result['error']}")
        sys.exit(1)
    else:
        print(result["message"])
