#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
arjun wrapper - MCP Code API Pattern (VPS Docker deployment)
Executes arjun API parameter discovery on VPS via SSH + docker exec, saves raw output, returns parsed summary
"""

import sys
import io
import json
import re
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def arjun(url: str, methods: Optional[List[str]] = None, engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute arjun parameter discovery on VPS and return parsed summary.

    Args:
        url: Target URL (e.g., https://example.com/api/users)
        methods: HTTP methods to test (default: ["GET", "POST"])
        engagement_dir: Optional engagement directory path
                       If provided, saves to engagement/03-exploitation/arjun/
                       If None, saves to sessions/[date]/scans/arjun/

    Returns:
        Dict with:
        - summary: Parsed findings (discovered parameters)
        - parameters: Dict of method -> list of parameters
        - count: Total number of parameters found
        - outputFile: Path to raw arjun output (local)
        - message: Human-readable summary
    """

    # Default methods
    if methods is None:
        methods = ["GET", "POST"]

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    url_safe = url.replace("https://", "").replace("http://", "").replace("/", "_").replace(":", "_")
    filename = f"{url_safe}-{timestamp}"

    # Determine output directory (local storage)
    if engagement_dir:
        output_dir = Path(engagement_dir) / "03-exploitation" / "arjun"
    else:
        today = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / today / "scans" / "arjun"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / f"{filename}.txt"
    json_file = output_dir / f"{filename}.json"

    # Build arjun command
    methods_str = ",".join(methods)
    cmd = f"arjun -u {url} --methods {methods_str} -oJ {json_file.name}"

    print(f"[arjun] Scanning URL: {url}")
    print(f"[arjun] Methods: {methods_str}")
    print(f"[arjun] This may take several minutes...")

    # Execute arjun via VPS (from container, output to container's /data)
    container_json = f"/data/{json_file.name}"
    docker_cmd = f"arjun -u {url} --methods {methods_str} -oJ {container_json}"
    raw_output = docker_exec("kali-pentest", docker_cmd)

    # Save raw output
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(raw_output)

    # Try to download and parse JSON results
    parameters = {}
    total_params = 0

    try:
        # Download JSON from VPS container
        from utils.vps_utils import docker_copy_from
        docker_copy_from("kali-pentest", container_json, str(json_file))

        # Parse JSON
        with open(json_file, 'r', encoding='utf-8') as f:
            results = json.load(f)

        # Extract parameters per method
        for method in methods:
            method_params = results.get(method, [])
            if method_params:
                parameters[method] = method_params
                total_params += len(method_params)

    except Exception as e:
        # Fallback: Parse from raw output
        print(f"[arjun] Warning: Could not parse JSON ({e}), parsing text output")

        # Simple regex parsing from text output
        for line in raw_output.split('\n'):
            if "Found" in line or "parameter" in line.lower():
                # Try to extract parameter names
                matches = re.findall(r'\b[a-zA-Z_][a-zA-Z0-9_]*\b', line)
                if matches:
                    for method in methods:
                        if method not in parameters:
                            parameters[method] = []
                        parameters[method].extend(matches)

        total_params = sum(len(params) for params in parameters.values())

    # Build summary
    summary = {
        "url": url,
        "methods_tested": methods,
        "parameters_found": total_params,
        "by_method": parameters
    }

    message = f"Found {total_params} parameters for {url}"

    print(f"\n[arjun] Scan complete!")
    print(f"[arjun] Parameters found: {total_params}")
    for method, params in parameters.items():
        if params:
            print(f"[arjun]   {method}: {', '.join(params)}")
    print(f"[arjun] Output saved to: {output_file}")

    return {
        "summary": summary,
        "parameters": parameters,
        "count": total_params,
        "outputFile": str(output_file),
        "jsonFile": str(json_file) if json_file.exists() else None,
        "message": message
    }


if __name__ == "__main__":
    # Test execution
    result = arjun("https://example.com/api/users", methods=["GET", "POST"])
    print(f"\nMessage: {result['message']}")
    print(f"Parameters found: {result['count']}")
    if result.get('parameters'):
        print(f"Details: {result['parameters']}")
