#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
amass wrapper - MCP Code API Pattern (VPS Docker deployment)
Executes amass subdomain discovery on VPS via SSH + docker exec, saves raw output, returns parsed summary
"""

import sys
import io
import re
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def amass(domain: str, mode: str = "passive", engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute amass subdomain discovery on VPS and return parsed summary.

    Args:
        domain: Target domain (e.g., example.com)
        mode: "passive" (OSINT only) or "active" (includes DNS brute force)
        engagement_dir: Optional engagement directory path
                       If provided, saves to engagement/02-reconnaissance/amass/
                       If None, saves to sessions/[date]/scans/amass/

    Returns:
        Dict with:
        - summary: Parsed findings (subdomains discovered)
        - subdomains: List of discovered subdomains
        - count: Number of subdomains found
        - outputFile: Path to raw amass output (local)
        - message: Human-readable summary
    """

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    filename = f"{domain.replace('.', '_')}-{mode}-{timestamp}.txt"

    # Determine output directory (local storage)
    if engagement_dir:
        output_dir = Path(engagement_dir) / "02-reconnaissance" / "amass"
    else:
        today = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / today / "scans" / "amass"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / filename

    # Build amass command
    if mode == "active":
        cmd = f"amass enum -d {domain} -active"
    elif mode == "passive":
        cmd = f"amass enum -d {domain}"
    else:
        return {
            "error": f"Invalid mode: {mode}. Must be 'passive' or 'active'.",
            "summary": {},
            "message": f"Error: Invalid mode '{mode}'"
        }

    print(f"[amass] Scanning domain: {domain}")
    print(f"[amass] Mode: {mode}")
    print(f"[amass] This may take several minutes...")

    # Execute amass via VPS
    raw_output = docker_exec("kali-pentest", cmd)

    # Save raw output
    with open(output_file, 'w', encoding='utf-8') as f:
        f.write(raw_output)

    # Parse subdomains from output
    subdomains = []
    for line in raw_output.strip().split('\n'):
        line = line.strip()
        # amass outputs subdomains one per line
        if line and '.' in line:
            subdomains.append(line)

    # Build summary
    summary = {
        "domain": domain,
        "mode": mode,
        "subdomains_found": len(subdomains),
        "subdomains": subdomains
    }

    message = f"Found {len(subdomains)} subdomains for {domain} using {mode} mode"

    print(f"\n[amass] Scan complete!")
    print(f"[amass] Subdomains found: {len(subdomains)}")
    print(f"[amass] Output saved to: {output_file}")

    return {
        "summary": summary,
        "subdomains": subdomains,
        "count": len(subdomains),
        "outputFile": str(output_file),
        "message": message
    }


if __name__ == "__main__":
    # Test execution
    result = amass("example.com", mode="passive")
    print(f"\nMessage: {result['message']}")
    print(f"Subdomains found: {result['count']}")
    if result.get('subdomains'):
        print(f"First 5 subdomains: {result['subdomains'][:5]}")
