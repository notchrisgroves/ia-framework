#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
cvemap wrapper - MCP Code API Pattern (VPS Docker deployment)
Executes cvemap, saves raw output, returns parsed summary
"""

import sys
import io
import json
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def cvemap(query: str, options: str = "", engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute cvemap CVE intelligence search.

    Args:
        query: Search query (CVE ID, keyword, etc.)
        options: Additional cvemap options
        engagement_dir: Optional engagement directory path

    Returns:
        Dict with:
        - summary: Parsed findings (CVE details, severity)
        - outputFile: Path to raw cvemap output
        - message: Human-readable summary
    """

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    safe_query = query.replace("/", "_").replace(":", "_").replace(" ", "_")
    filename = f"{safe_query}-{timestamp}.json"

    # Determine output directory
    if engagement_dir:
        output_dir = Path(engagement_dir) / "02-reconnaissance" / "cvemap"
    else:
        session_date = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / session_date / "scans" / "cvemap"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / filename

    # Execute cvemap with JSON output
    cmd = f"cvemap -q '{query}' {options} -json -o {output_file}"

    try:
        result = docker_exec("kali-pentest", cmd, timeout=120)

        if result["returncode"] != 0 and not output_file.exists():
            return {
                "error": f"cvemap execution failed: {result["stderr"]}",
                "outputFile": str(output_file)
            }

        # Parse the output
        summary = parse_cvemap_output(output_file)

        # Generate message
        total = summary["cveCount"]
        message = f"[+] cvemap search complete\n"
        message += f"    Query: {query}\n"
        message += f"    CVEs found: {total}\n"

        if summary["bySeverity"]:
            message += f"    By severity:\n"
            for sev in ['CRITICAL', 'HIGH', 'MEDIUM', 'LOW']:
                if sev in summary["bySeverity"]:
                    message += f"      {sev}: {summary['bySeverity'][sev]}\n"

        if summary["topCVEs"]:
            message += f"    Top CVEs (first 5):\n"
            for cve in summary["topCVEs"][:5]:
                severity = cve.get('severity', 'UNKNOWN')
                cve_id = cve.get('cve_id', 'N/A')
                message += f"      [{severity}] {cve_id}\n"
                if cve.get('description'):
                    desc = cve['description'][:100] + "..." if len(cve['description']) > 100 else cve['description']
                    message += f"        {desc}\n"

        message += f"    Full results: {output_file}"

        return {
            "summary": summary,
            "outputFile": str(output_file),
            "message": message
        }

    except subprocess.TimeoutExpired:
        return {
            "error": "cvemap timed out (2 minutes)",
            "outputFile": str(output_file)
        }
    except Exception as e:
        return {
            "error": f"cvemap execution error: {str(e)}",
            "outputFile": str(output_file)
        }


def parse_cvemap_output(filepath: Path) -> Dict:
    """Parse cvemap JSON output file."""

    if not filepath.exists():
        return {
            "cveCount": 0,
            "bySeverity": {},
            "topCVEs": []
        }

    cves = []
    by_severity = {}

    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            for line in f:
                line = line.strip()
                if not line:
                    continue

                try:
                    cve = json.loads(line)
                    cves.append(cve)

                    # Count by severity
                    severity = cve.get('severity', 'UNKNOWN').upper()
                    by_severity[severity] = by_severity.get(severity, 0) + 1

                except json.JSONDecodeError:
                    continue
    except Exception:
        return {
            "cveCount": 0,
            "bySeverity": {},
            "topCVEs": []
        }

    # Extract top CVEs for summary
    top_cves = []
    for cve in cves[:20]:  # Top 20
        top_cves.append({
            "cve_id": cve.get('cve_id', 'N/A'),
            "severity": cve.get('severity', 'UNKNOWN'),
            "description": cve.get('cve_description', ''),
            "published": cve.get('published_date', '')
        })

    return {
        "cveCount": len(cves),
        "bySeverity": by_severity,
        "topCVEs": top_cves
    }


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python cvemap.py <query> [options] [engagement_dir]")
        print("Example: python cvemap.py 'CVE-2023-1234'")
        print("Example: python cvemap.py 'apache' '-s critical,high'")
        sys.exit(1)

    query = sys.argv[1]
    options = sys.argv[2] if len(sys.argv) > 2 else ""
    engagement_dir = sys.argv[3] if len(sys.argv) > 3 else None

    result = cvemap(query, options, engagement_dir)

    if "error" in result:
        print(f"[!] Error: {result['error']}")
        sys.exit(1)
    else:
        print(result["message"])
