#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
nmap wrapper - MCP Code API Pattern (VPS Docker deployment)
Executes nmap on VPS via SSH + docker exec, saves raw output, returns parsed summary
"""

import sys
import io
import re
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional

# Add parent directory to path for utils
sys.path.insert(0, str(Path(__file__).parent.parent))
from utils.vps_utils import docker_exec

# Force UTF-8 encoding for Windows console output
if sys.platform == 'win32':
    sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
    sys.stderr = io.TextIOWrapper(sys.stderr.buffer, encoding='utf-8')


def nmap(target: str, options: str = "-sV -sC", engagement_dir: Optional[str] = None) -> Dict:
    """
    Execute nmap scan on VPS and return parsed summary.

    Args:
        target: Target IP/hostname/CIDR
        options: Nmap options (default: -sV -sC)
        engagement_dir: Optional engagement directory path
                       If provided, saves to engagement/02-reconnaissance/nmap/
                       If None, saves to sessions/[date]/scans/nmap/

    Returns:
        Dict with:
        - summary: Parsed findings (open ports, services, OS)
        - outputFile: Path to raw nmap output (local)
        - message: Human-readable summary
    """

    # Generate output filename
    timestamp = datetime.now().strftime("%Y-%m-%dT%H-%M-%S")
    safe_target = target.replace("/", "_").replace(":", "_")
    filename = f"{safe_target}-{timestamp}.txt"

    # Determine output directory (local storage)
    if engagement_dir:
        output_dir = Path(engagement_dir) / "02-reconnaissance" / "nmap"
    else:
        session_date = datetime.now().strftime("%Y-%m-%d")
        output_dir = Path.home() / ".claude" / "sessions" / session_date / "scans" / "nmap"

    output_dir.mkdir(parents=True, exist_ok=True)
    output_file = output_dir / filename

    # Execute nmap on VPS via docker exec
    cmd = f"nmap {options} {target}"

    try:
        result = docker_exec("kali-pentest", cmd, timeout=600)

        if result["returncode"] != 0:
            # Write error to file for audit trail
            with open(output_file, 'w', encoding='utf-8') as f:
                f.write(f"[!] Nmap execution failed\n")
                f.write(f"Command: {cmd}\n")
                f.write(f"Exit code: {result['returncode']}\n\n")
                f.write(f"STDERR:\n{result['stderr']}\n\n")
                f.write(f"STDOUT:\n{result['stdout']}\n")

            return {
                "error": f"Nmap execution failed: {result['stderr']}",
                "outputFile": str(output_file)
            }

        # Write output to local file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(result["stdout"])

        # Parse the output
        summary = parse_nmap_output(output_file)

        # Generate human-readable message
        open_count = len(summary["openPorts"])
        service_count = len(summary["services"])

        message = f"[+] Nmap scan complete (VPS: kali-pentest container)\n"
        message += f"    Target: {target}\n"
        message += f"    Open ports: {open_count}\n"
        message += f"    Services identified: {service_count}\n"

        if summary["openPorts"]:
            message += f"    Ports: {', '.join(map(str, summary['openPorts']))}\n"

        if summary["osGuess"]:
            message += f"    OS: {summary['osGuess']}\n"

        message += f"    Full results: {output_file}"

        return {
            "summary": summary,
            "outputFile": str(output_file),
            "message": message
        }

    except Exception as e:
        # Write error to file
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(f"[!] Nmap wrapper error\n")
            f.write(f"Error: {str(e)}\n")

        return {
            "error": f"Nmap execution error: {str(e)}",
            "outputFile": str(output_file)
        }


def parse_nmap_output(filepath: Path) -> Dict:
    """
    Parse nmap output file and extract key findings.

    Returns:
        Dict with openPorts, services, osGuess
    """

    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    open_ports = []
    services = []
    os_guess = None

    # Extract open ports
    port_pattern = r'^(\d+)/tcp\s+open\s+(\S+)(?:\s+(.+))?$'
    for line in content.split('\n'):
        match = re.match(port_pattern, line.strip())
        if match:
            port = int(match.group(1))
            service = match.group(2)
            version = match.group(3) if match.group(3) else ""

            open_ports.append(port)
            services.append({
                "port": port,
                "service": service,
                "version": version.strip()
            })

    # Extract OS guess
    os_pattern = r'OS details: (.+)'
    os_match = re.search(os_pattern, content)
    if os_match:
        os_guess = os_match.group(1).strip()

    return {
        "openPorts": open_ports,
        "services": services,
        "osGuess": os_guess
    }


if __name__ == "__main__":
    # CLI usage for testing
    if len(sys.argv) < 2:
        print("Usage: python nmap.py <target> [options] [engagement_dir]")
        print("Example: python nmap.py 192.168.1.1")
        print("Example: python nmap.py 192.168.1.1 '-p- -T4' /path/to/engagement")
        sys.exit(1)

    target = sys.argv[1]
    options = sys.argv[2] if len(sys.argv) > 2 else "-sV -sC"
    engagement_dir = sys.argv[3] if len(sys.argv) > 3 else None

    result = nmap(target, options, engagement_dir)

    if "error" in result:
        print(f"[!] Error: {result['error']}")
        sys.exit(1)
    else:
        print(result["message"])
