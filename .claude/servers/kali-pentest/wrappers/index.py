#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Kali Pentest MCP Server - Code API Pattern
Tool registry and exploration interface
"""

# Tool Registry
TOOLS = {
    "reconnaissance": {
        "nmap": {
            "description": "Network mapper - port scanning and service detection",
            "module": "nmap",
            "function": "nmap",
            "params": {
                "target": "IP/hostname/CIDR to scan",
                "options": "Nmap options (default: -sV -sC)",
                "engagement_dir": "Optional engagement directory path"
            },
            "output": "file",
            "returns": "Parsed summary with open ports, services, OS guess"
        },
        "subfinder": {
            "description": "Passive subdomain enumeration",
            "module": "subfinder",
            "function": "subfinder",
            "output": "file",
            "returns": "Subdomain count and sample list"
        },
        "httpx": {
            "description": "HTTP toolkit for probing and analysis",
            "module": "httpx",
            "function": "httpx",
            "output": "file",
            "returns": "Live hosts with status codes and titles"
        },
        "naabu": {
            "description": "Fast port scanner",
            "module": "naabu",
            "function": "naabu",
            "output": "file",
            "returns": "Open ports summary"
        },
        "katana": {
            "description": "Web crawler for endpoint discovery",
            "module": "katana",
            "function": "katana",
            "output": "file",
            "returns": "Endpoint count and categories"
        }
    },
    "vulnerability_scanning": {
        "nuclei": {
            "description": "Template-based vulnerability scanner (PRIMARY)",
            "module": "nuclei",
            "function": "nuclei",
            "output": "file",
            "returns": "Vulnerability summary by severity"
        },
        "nikto": {
            "description": "Web server vulnerability scanner",
            "module": "nikto",
            "function": "nikto",
            "output": "file",
            "returns": "Critical findings summary"
        },
        "wapiti": {
            "description": "Web application vulnerability scanner",
            "module": "wapiti",
            "function": "wapiti",
            "output": "file",
            "returns": "Vulnerability types found"
        },
        "wpscan": {
            "description": "WordPress vulnerability scanner",
            "module": "wpscan",
            "function": "wpscan",
            "output": "file",
            "returns": "WordPress vulnerabilities and misconfigurations"
        }
    },
    "exploitation": {
        "sqlmap": {
            "description": "SQL injection detection and exploitation",
            "module": "sqlmap",
            "function": "sqlmap",
            "output": "file",
            "returns": "Injection points and database info"
        },
        "hydra": {
            "description": "Password brute forcing tool",
            "module": "hydra",
            "function": "hydra",
            "output": "file",
            "returns": "Valid credentials found"
        },
        "dirb": {
            "description": "Directory brute forcing",
            "module": "dirb",
            "function": "dirb",
            "output": "file",
            "returns": "Interesting paths found"
        }
    },
    "intelligence": {
        "searchsploit": {
            "description": "ExploitDB search utility",
            "module": "searchsploit",
            "function": "searchsploit",
            "output": "direct",
            "returns": "Matching exploits"
        },
        "cvemap": {
            "description": "CVE intelligence tool",
            "module": "cvemap",
            "function": "cvemap",
            "output": "direct",
            "returns": "CVE details"
        }
    },
    "post_exploitation": {
        "crackmapexec": {
            "description": "Windows network reconnaissance and credential testing",
            "module": "crackmapexec",
            "function": "crackmapexec",
            "output": "file",
            "returns": "Network enumeration results"
        },
        "responder": {
            "description": "LLMNR/NBT-NS/MDNS poisoner",
            "module": "responder",
            "function": "responder",
            "output": "file",
            "returns": "Captured credentials"
        },
        "netcat": {
            "description": "Netcat listener for reverse shells",
            "module": "netcat",
            "function": "netcat_listener",
            "output": "direct",
            "returns": "Listener status"
        }
    }
}


def list_tools(category: str = None, detail_level: str = "summary") -> dict:
    """
    List available tools with optional filtering.

    Args:
        category: Filter by category (reconnaissance, vulnerability_scanning, etc.)
        detail_level: "summary" (names only), "descriptions", or "full" (all details)

    Returns:
        Dict of tools organized by category
    """

    if category and category in TOOLS:
        tools = {category: TOOLS[category]}
    else:
        tools = TOOLS

    if detail_level == "summary":
        # Return tool names only
        return {
            cat: list(tools_dict.keys())
            for cat, tools_dict in tools.items()
        }
    elif detail_level == "descriptions":
        # Return names + descriptions
        return {
            cat: {
                name: tool["description"]
                for name, tool in tools_dict.items()
            }
            for cat, tools_dict in tools.items()
        }
    else:  # full
        return tools


def search_tools(keyword: str) -> dict:
    """
    Search tools by keyword in name or description.

    Args:
        keyword: Search term

    Returns:
        Dict of matching tools
    """

    matches = {}
    keyword_lower = keyword.lower()

    for category, tools_dict in TOOLS.items():
        for name, tool in tools_dict.items():
            if (keyword_lower in name.lower() or
                keyword_lower in tool["description"].lower()):
                if category not in matches:
                    matches[category] = {}
                matches[category][name] = tool

    return matches


if __name__ == "__main__":
    import json

    print("=== Kali Pentest Tool Registry ===\n")

    print("Tool Summary:")
    print(json.dumps(list_tools(detail_level="summary"), indent=2))

    print("\n\nSearch 'web':")
    print(json.dumps(search_tools("web"), indent=2))
